import os
from dotenv import load_dotenv
from typing import TypedDict
from pydantic import BaseModel, Field

from langgraph.graph import StateGraph, START, END
from langchain_openai import ChatOpenAI

# 1. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
load_dotenv()
if not os.getenv("OPENAI_API_KEY"):
    print("Error: OPENAI_API_KEY missing.")
    exit(1)

# 2. ØªØ¹Ø±ÛŒÙ Ø³Ø§Ø®ØªØ§Ø± Ø¬ÙˆÚ© (Data Model) Ø¨Ø§ Pydantic
# Ø§ÛŒÙ† Ú©Ù„Ø§Ø³ Ø¨Ù‡ LLM Ù…ÛŒâ€ŒÙÙ‡Ù…Ø§Ù†Ø¯ Ú©Ù‡ Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø§ÛŒØ¯ Ú†Ù‡ Ø´Ú©Ù„ÛŒ Ø¨Ø§Ø´Ø¯.
class Joke(BaseModel):
    setup: str = Field(description="Ù…Ù‚Ø¯Ù…Ù‡ ÛŒØ§ Ø¨Ø®Ø´ Ø§ÙˆÙ„ Ø¬ÙˆÚ© Ú©Ù‡ Ø´Ù†ÙˆÙ†Ø¯Ù‡ Ø±Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯")
    punchline: str = Field(description="Ø¨Ø®Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø®Ù†Ø¯Ù‡â€ŒØ¯Ø§Ø± Ø¬ÙˆÚ©")
    rating: int = Field(description="Ù…ÛŒØ²Ø§Ù† Ø¨Ø§Ù…Ø²Ú¯ÛŒ Ø¬ÙˆÚ© Ø§Ø² Û± ØªØ§ Û±Û° Ø¨Ù‡ Ù†Ø¸Ø± Ø®ÙˆØ¯Øª", ge=1, le=10)

# 3. ØªØ¹Ø±ÛŒÙ Ø§Ø³ØªÛŒØª (State)
# Ø¯Ø± Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ØŒ Ù…Ø§ Ù„ÛŒØ³Øª Ù¾ÛŒØ§Ù… Ù†Ø¯Ø§Ø±ÛŒÙ…. ÙÙ‚Ø· ÙˆØ±ÙˆØ¯ÛŒ (Ù…ÙˆØ¶ÙˆØ¹) Ùˆ Ø®Ø±ÙˆØ¬ÛŒ (Ø¬ÙˆÚ©) Ø¯Ø§Ø±ÛŒÙ….
class State(TypedDict):
    topic: str      # ÙˆØ±ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±
    generated_joke: Joke  # Ø®Ø±ÙˆØ¬ÛŒ Ù…Ø¯Ù„ (Ø§Ø² Ø¬Ù†Ø³ Ú©Ù„Ø§Ø³ Joke Ø¨Ø§Ù„Ø§)

# 4. Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø¯Ù„
llm = ChatOpenAI(model="gpt-4o-mini", temperature=0.7)

# --- Ø¬Ø§Ø¯ÙˆÛŒ Ø§ØµÙ„ÛŒ Ø§ÛŒÙ†Ø¬Ø§Ø³Øª ---
# Ø¨Ù‡ Ù…Ø¯Ù„ Ù…ÛŒâ€ŒÚ¯ÙˆÛŒÛŒÙ…: "Ø®Ø±ÙˆØ¬ÛŒ ØªÙˆ Ø­ØªÙ…Ø§Ù‹ Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ù‚Ø§Ù„Ø¨ Ú©Ù„Ø§Ø³ Joke Ø¨Ø§Ø´Ø¯"
structured_llm = llm.with_structured_output(Joke)

# 5. ØªØ¹Ø±ÛŒÙ Ù†ÙˆØ¯ (Node)
def generate_joke_node(state: State):
    topic = state["topic"]
    
    # Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø² Ù…Ø¯Ù„
    # Ø¯Ù‚Øª Ú©Ù†ÛŒØ¯ Ú©Ù‡ Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù¾Ø±Ø§Ù…Ù¾Øª Ø±Ø§ Ù…Ø³ØªÙ‚ÛŒÙ… Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ…
    prompt = f"ÛŒÚ© Ø¬ÙˆÚ© Ø®ÛŒÙ„ÛŒ Ø®Ù†Ø¯Ù‡â€ŒØ¯Ø§Ø± Ø¯Ø±Ø¨Ø§Ø±Ù‡ '{topic}' Ø¨Ú¯Ùˆ."
    
    # Ú†ÙˆÙ† Ø§Ø² structured_llm Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ø±Ø¯ÛŒÙ…ØŒ Ø®Ø±ÙˆØ¬ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ ÛŒÚ© Ø¢Ø¨Ø¬Ú©Øª Joke Ø§Ø³Øª (Ù†Ù‡ Ù…ØªÙ† Ø®Ø§Ù„ÛŒ)
    response_object = structured_llm.invoke(prompt)
    
    # Ø¢Ù¾Ø¯ÛŒØª Ú©Ø±Ø¯Ù† Ø§Ø³ØªÛŒØª
    # Ø§ÛŒÙ†Ø¬Ø§ Ú†ÙˆÙ† Ù„ÛŒØ³Øª Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ù…Ù‚Ø¯Ø§Ø± Ù‚Ø¨Ù„ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Overwrite)
    return {"generated_joke": response_object}

# 6. Ø³Ø§Ø®Øª Ú¯Ø±Ø§Ù
builder = StateGraph(State)

builder.add_node("joke_generator", generate_joke_node)

builder.add_edge(START, "joke_generator")
builder.add_edge("joke_generator", END)

graph = builder.compile()

# 7. Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡
def main():
    print("--- Structured Joke Generator ---")
    while True:
        user_topic = input("\nÙ…ÙˆØ¶ÙˆØ¹ Ø¬ÙˆÚ© Ø±Ùˆ Ø¨Ú¯Ùˆ (ÛŒØ§ quit): ")
        if user_topic.lower() in ["quit", "exit"]:
            break
            
        # Ø§Ø¬Ø±Ø§
        result = graph.invoke({"topic": user_topic})
        
        # Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø®Ø±ÙˆØ¬ÛŒ
        joke = result["generated_joke"]
        
        print(f"\nğŸ­ Setup: {joke.setup}")
        print(f"ğŸ˜‚ Punchline: {joke.punchline}")
        print(f"â­ Rating: {joke.rating}/10")

        # Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¨Ø¨ÛŒÙ†ÛŒ Ù¾Ø´Øª ØµØ­Ù†Ù‡ Ú†Ù‡ Ø®Ø¨Ø±Ù‡ØŒ ÙØ±Ù…Øª Ø®Ø§Ù… Ø±Ùˆ Ù‡Ù… Ù¾Ø±ÛŒÙ†Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        print(f"\n[Raw Data]: {joke}")

if __name__ == "__main__":
    main()